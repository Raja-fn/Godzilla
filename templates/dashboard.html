{% extends 'base.html' %}
{% block content %}
<!-- Hero Section -->
<section class="hero-section mb-5">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <h1 class="display-4 fw-bold mb-3" style="color: #1a202c;">Your Health, Simplified</h1>
        <p class="lead text-muted mb-4">
          Track your workouts, meals, and progress with our intuitive dashboard. Stay motivated and reach your fitness goals faster.
        </p>
      </div>
      <div class="col-lg-6 text-end">
        <div class="hero-icons">
          <i class="fas fa-dumbbell" style="font-size: 3rem; color: #fbbf24; margin: 10px;"></i>
          <i class="fas fa-running" style="font-size: 2.5rem; color: #3b82f6; margin: 10px;"></i>
          <i class="fas fa-bowl-food" style="font-size: 2.8rem; color: #8b5cf6; margin: 10px;"></i>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Latest Decision & AI Recommendation Card -->
{% if latest_recommendation %}
<section class="latest-decision-section mb-4">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card latest-decision-card p-4" style="border-radius: 20px; border: none; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: relative; overflow: hidden; border: 3px solid rgba(255,255,255,0.3);">
          <!-- Decorative background elements -->
          <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
          <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
          <div style="position: absolute; top: 20px; right: 20px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
          
          <!-- Header with Badge -->
          <div class="d-flex align-items-center justify-content-between mb-3" style="position: relative; z-index: 1;">
            <div class="d-flex align-items-center">
              <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.25); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                <i class="fas fa-robot" style="font-size: 1.5rem;"></i>
              </div>
              <div>
                <h4 class="mb-0 fw-bold">Latest AI Decision</h4>
                <small style="opacity: 0.8;">Based on your latest check-in analysis</small>
              </div>
            </div>
            <div class="text-end">
              {% if latest_recommendation.get("priority") == "high" %}
              <span class="badge" style="background: rgba(239, 68, 68, 0.9); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                <i class="fas fa-exclamation-circle me-1"></i>High Priority
              </span>
              {% elif latest_recommendation.get("priority") == "medium" %}
              <span class="badge" style="background: rgba(245, 158, 11, 0.9); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                <i class="fas fa-info-circle me-1"></i>Medium Priority
              </span>
              {% else %}
              <span class="badge" style="background: rgba(16, 185, 129, 0.9); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                <i class="fas fa-check-circle me-1"></i>Low Priority
              </span>
              {% endif %}
            </div>
          </div>

          <div class="row align-items-center" style="position: relative; z-index: 1;">
            <div class="col-lg-2 text-center mb-3 mb-lg-0">
              <div style="width: 90px; height: 90px; background: rgba(255,255,255,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 3px solid rgba(255,255,255,0.3);">
                {% if latest_recommendation.get("icon") == "bed" %}
                <i class="fas fa-bed" style="font-size: 2.5rem;"></i>
                {% elif latest_recommendation.get("icon") == "heartbeat" %}
                <i class="fas fa-heartbeat" style="font-size: 2.5rem;"></i>
                {% elif latest_recommendation.get("icon") == "dumbbell" %}
                <i class="fas fa-dumbbell" style="font-size: 2.5rem;"></i>
                {% elif latest_recommendation.get("icon") == "battery-half" %}
                <i class="fas fa-battery-half" style="font-size: 2.5rem;"></i>
                {% elif latest_recommendation.get("icon") == "target" %}
                <i class="fas fa-bullseye" style="font-size: 2.5rem;"></i>
                {% else %}
                <i class="fas fa-sparkles" style="font-size: 2.5rem;"></i>
                {% endif %}
              </div>
            </div>
            
            <div class="col-lg-7 mb-3 mb-lg-0">
              <h3 class="fw-bold mb-3" style="font-size: 1.75rem;">{{ latest_recommendation.get("title", "Health Recommendation") }}</h3>
              <p class="mb-3" style="opacity: 0.95; font-size: 1.1rem; line-height: 1.6;">{{ latest_recommendation.get("personalized_message", "Based on your recent check-ins, here's what we recommend for tomorrow.") }}</p>
              
              <!-- Main Action Highlight -->
              <div style="background: rgba(255,255,255,0.25); border-radius: 16px; padding: 1.25rem; border-left: 4px solid rgba(255,255,255,0.8);">
                <div class="d-flex align-items-center">
                  <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                    <i class="fas fa-lightbulb"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="small mb-1" style="opacity: 0.9;">What You Should Do Next:</div>
                    <p class="mb-0 fw-bold" style="font-size: 1.25rem;">{{ latest_recommendation.get("main_action", "Continue your healthy routine") }}</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-lg-3">
              <div class="text-center">
                <button class="btn btn-light btn-lg w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#recommendationTips" style="border-radius: 12px; padding: 0.75rem; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                  <i class="fas fa-lightbulb me-2"></i>View Action Steps
                </button>
                <small class="d-block mt-2" style="opacity: 0.8;">
                  <i class="fas fa-robot me-1"></i>AI-Powered Analysis
                </small>
              </div>
            </div>
          </div>
          
          <!-- Expanded Tips Section -->
          <div class="collapse mt-4" id="recommendationTips" style="position: relative; z-index: 1;">
            <div style="background: rgba(255,255,255,0.2); border-radius: 16px; padding: 2rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);">
              <div class="d-flex align-items-center mb-4">
                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                  <i class="fas fa-tasks" style="font-size: 1.5rem;"></i>
                </div>
                <div>
                  <h5 class="fw-bold mb-0">Action Steps to Follow</h5>
                  <small style="opacity: 0.9;">Detailed recommendations based on your latest check-in</small>
                </div>
              </div>
              <div class="row g-4">
                {% for tip in latest_recommendation.get("tips", []) %}
                <div class="col-md-6">
                  <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 1.25rem; border-left: 3px solid rgba(255,255,255,0.5);">
                    <div class="d-flex align-items-start">
                      <div style="width: 35px; height: 35px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                        <i class="fas fa-check" style="font-size: 0.875rem;"></i>
                      </div>
                      <p class="mb-0" style="line-height: 1.7; font-size: 1.05rem;">{{ tip }}</p>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% else %}
<!-- No Recommendation Yet -->
<section class="latest-decision-section mb-4">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card p-4 text-center" style="border-radius: 20px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
          <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
            <i class="fas fa-clipboard-check text-white" style="font-size: 2rem;"></i>
          </div>
          <h4 class="fw-bold mb-2" style="color: #1a202c;">No AI Decision Yet</h4>
          <p class="text-muted mb-3">Complete your first check-in to get personalized AI recommendations!</p>
          <a href="{{ url_for('log_today') }}" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; padding: 0.75rem 2rem;">
            <i class="fas fa-plus-circle me-2"></i>Check In Now
          </a>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Personalized Daily Summary -->
<section class="daily-summary mb-4">
      <div class="container-fluid">
    <div class="row">
      <div class="col-lg-8 mb-4">
        <div class="card p-4" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
          <div class="d-flex align-items-center mb-4">
            <i class="fas fa-sun me-3" style="font-size: 2rem; color: #fbbf24;"></i>
            <div>
              <h3 class="mb-0">Good Morning</h3>
              <p class="text-muted mb-0">Cecilia Park</p>
            </div>
          </div>
          
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="metric-card p-3" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px;">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <p class="text-muted mb-1 small">Weight</p>
                    <h4 class="mb-0 fw-bold">80.2 kg</h4>
                  </div>
                  <i class="fas fa-weight" style="font-size: 1.5rem; color: #10b981;"></i>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card p-3" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px;">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <p class="text-muted mb-1 small">Calories</p>
                    <h4 class="mb-0 fw-bold">4901 kcal</h4>
                  </div>
                  <i class="fas fa-fire" style="font-size: 1.5rem; color: #3b82f6;"></i>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="metric-card p-3" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px;">
                <div>
                  <p class="text-muted mb-2 small">Steps</p>
                  <div class="progress" style="height: 8px; border-radius: 10px; background: #f3f4f6;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%); width: 65%;"></div>
                  </div>
                  <p class="mb-0 mt-2 small fw-bold">6,500 / 10,000</p>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <h6 class="fw-bold mb-3">To schedule</h6>
              <ul class="list-unstyled">
                <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Morning workout</li>
                <li class="mb-2"><i class="fas fa-circle text-muted me-2" style="font-size: 0.5rem;"></i>Meal prep</li>
                <li class="mb-2"><i class="fas fa-circle text-muted me-2" style="font-size: 0.5rem;"></i>Evening run</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="fw-bold mb-3">Body Analysis</h6>
              <div class="d-flex align-items-center">
                <div class="flex-grow-1 me-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span class="small">Muscle Mass</span>
                    <span class="small fw-bold">75%</span>
                  </div>
                  <div class="progress" style="height: 6px; border-radius: 10px;">
                    <div class="progress-bar bg-success" style="width: 75%;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule Timeline -->
      <div class="col-lg-4">
        <div class="card p-4" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0">Today's Schedule</h5>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#addTaskForm" style="border-radius: 8px;">
              <i class="fas fa-plus"></i> Add Task
            </button>
          </div>
          
          <!-- Add Task Form -->
          <div class="collapse mb-3" id="addTaskForm">
            <div class="card-body p-3" style="background: #f8fafc; border-radius: 12px;">
              <form id="taskForm">
                <div class="mb-3">
                  <label class="form-label small fw-bold">Task Name</label>
                  <input type="text" class="form-control form-control-sm" id="taskName" placeholder="Enter task name" required style="border-radius: 8px;">
                </div>
                <div class="mb-3">
                  <label class="form-label small fw-bold">Time</label>
                  <input type="time" class="form-control form-control-sm" id="taskTime" required style="border-radius: 8px;">
                </div>
                <div class="mb-2">
                  <label class="form-label small fw-bold">Type</label>
                  <select class="form-select form-select-sm" id="taskType" style="border-radius: 8px;">
                    <option value="default">Default</option>
                    <option value="primary">Important</option>
                    <option value="danger">Urgent</option>
                    <option value="success">Completed</option>
                  </select>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary btn-sm flex-grow-1" style="border-radius: 8px;">
                    <i class="fas fa-check"></i> Add
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#addTaskForm" style="border-radius: 8px;">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <div class="schedule-timeline" id="scheduleTimeline">
            <!-- Tasks will be dynamically loaded here -->
            <div class="text-center text-muted py-3" id="noTasksMsg">
              <i class="fas fa-calendar-plus mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
              <p class="small mb-0">No tasks scheduled. Add your first task!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Main Analytics Section -->
<section class="main-analytics mb-4">
  <div class="container-fluid">
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <h2 class="fw-bold mb-1" style="color: #1a202c;">Your Analytics</h2>
            <p class="text-muted mb-0">Comprehensive overview of your fitness journey</p>
          </div>
          {% if current_user %}
          <div class="d-flex align-items-center gap-3">
            <div class="text-end">
              <div class="small text-muted">Current Level</div>
              <div class="fw-bold" style="font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Level {{ current_user.level }}</div>
            </div>
            <div class="text-end">
              <div class="small text-muted">Experience Points</div>
              <div class="fw-bold" style="font-size: 1.5rem; color: #10b981;">{{ current_user.experience_points }} XP</div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="row g-4 mb-4">
      <!-- Overall Stats -->
      <div class="col-lg-3 col-md-6">
        <div class="analytics-card h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 2rem; color: white; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="small mb-1" style="opacity: 0.9;">Total Workouts</div>
              <h2 class="fw-bold mb-0">{{ total_workouts }}</h2>
            </div>
            <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-dumbbell" style="font-size: 1.75rem;"></i>
            </div>
          </div>
          <div class="small" style="opacity: 0.8;">
            <i class="fas fa-chart-line me-1"></i>{{ month_workouts }} this month
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="analytics-card h-100" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 2rem; color: white; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="small mb-1" style="opacity: 0.9;">Consistency</div>
              <h2 class="fw-bold mb-0">{{ "%.0f"|format(consistency_rate) }}%</h2>
            </div>
            <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-check-circle" style="font-size: 1.75rem;"></i>
            </div>
          </div>
          <div class="small" style="opacity: 0.8;">
            <i class="fas fa-fire me-1"></i>{{ current_streak }} day streak
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="analytics-card h-100" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 16px; padding: 2rem; color: white; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="small mb-1" style="opacity: 0.9;">Avg Sleep</div>
              <h2 class="fw-bold mb-0">{{ "%.1f"|format(overall_avg_sleep) if overall_avg_sleep else 'N/A' }}<small style="font-size: 1rem; opacity: 0.8;">h</small></h2>
            </div>
            <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-bed" style="font-size: 1.75rem;"></i>
            </div>
          </div>
          <div class="small" style="opacity: 0.8;">
            <i class="fas fa-calendar-week me-1"></i>{{ "%.1f"|format(week_avg_sleep) if week_avg_sleep else 'N/A' }}h this week
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="analytics-card h-100" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 16px; padding: 2rem; color: white; box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="small mb-1" style="opacity: 0.9;">This Week</div>
              <h2 class="fw-bold mb-0">{{ week_workouts }}</h2>
            </div>
            <div style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-calendar-alt" style="font-size: 1.75rem;"></i>
            </div>
          </div>
          <div class="small" style="opacity: 0.8;">
            <i class="fas fa-trophy me-1"></i>Workouts completed
          </div>
        </div>
      </div>
    </div>
    
    <!-- Detailed Analytics Row -->
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card p-4 h-100" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
          <h5 class="fw-bold mb-4"><i class="fas fa-chart-pie me-2" style="color: #667eea;"></i>Activity Summary</h5>
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-bold">Total Check-ins</span>
              <span class="badge bg-primary" style="padding: 0.5rem 1rem; border-radius: 8px;">{{ total_logs }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-bold">Workouts Completed</span>
              <span class="badge bg-success" style="padding: 0.5rem 1rem; border-radius: 8px;">{{ total_workouts }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-bold">Missed Workouts</span>
              <span class="badge bg-danger" style="padding: 0.5rem 1rem; border-radius: 8px;">{{ total_missed }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-bold">Current Streak</span>
              <span class="badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.5rem 1rem; border-radius: 8px;">{{ current_streak }} days</span>
            </div>
          </div>
          <div class="progress" style="height: 12px; border-radius: 10px; background: #f3f4f6;">
            <div class="progress-bar" style="background: linear-gradient(90deg, #10b981 0%, #059669 100%); width: {{ consistency_rate }}%; border-radius: 10px;" role="progressbar"></div>
          </div>
          <div class="text-center mt-2">
            <small class="text-muted">Consistency Rate: {{ "%.1f"|format(consistency_rate) }}%</small>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="card p-4 h-100" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
          <h5 class="fw-bold mb-4"><i class="fas fa-calendar-check me-2" style="color: #3b82f6;"></i>Weekly Performance</h5>
          <div class="text-center mb-4">
            <div style="width: 120px; height: 120px; margin: 0 auto; position: relative;">
              <svg width="120" height="120" style="transform: rotate(-90deg);">
                <circle cx="60" cy="60" r="50" fill="none" stroke="#f3f4f6" stroke-width="10"></circle>
                <circle cx="60" cy="60" r="50" fill="none" stroke="url(#weeklyGradient)" stroke-width="10" 
                        stroke-dasharray="{{ (week_workouts / 7 * 314) if week_workouts else 0 }} 314" 
                        stroke-linecap="round"></circle>
                <defs>
                  <linearGradient id="weeklyGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                  </linearGradient>
                </defs>
              </svg>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div class="fw-bold" style="font-size: 1.5rem; color: #3b82f6;">{{ week_workouts }}</div>
                <div class="small text-muted">/ 7 days</div>
              </div>
            </div>
          </div>
          <div class="row text-center">
            <div class="col-6">
              <div class="small text-muted mb-1">This Week</div>
              <div class="fw-bold">{{ week_workouts }} workouts</div>
            </div>
            <div class="col-6">
              <div class="small text-muted mb-1">This Month</div>
              <div class="fw-bold">{{ month_workouts }} workouts</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="card p-4 h-100" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
          <h5 class="fw-bold mb-4"><i class="fas fa-trophy me-2" style="color: #f59e0b;"></i>Achievements</h5>
          <div class="achievement-list">
            {% if current_streak >= 7 %}
            <div class="achievement-item d-flex align-items-center mb-3 p-3" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                <i class="fas fa-fire text-white"></i>
              </div>
              <div>
                <div class="fw-bold">7-Day Streak!</div>
                <small class="text-muted">Keep the momentum going</small>
              </div>
            </div>
            {% endif %}
            
            {% if total_workouts >= 30 %}
            <div class="achievement-item d-flex align-items-center mb-3 p-3" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                <i class="fas fa-medal text-white"></i>
              </div>
              <div>
                <div class="fw-bold">30 Workouts Milestone!</div>
                <small class="text-muted">Excellent progress</small>
              </div>
            </div>
            {% endif %}
            
            {% if consistency_rate >= 80 %}
            <div class="achievement-item d-flex align-items-center mb-3 p-3" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 12px;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                <i class="fas fa-star text-white"></i>
              </div>
              <div>
                <div class="fw-bold">Consistency Champion!</div>
                <small class="text-muted">{{ "%.0f"|format(consistency_rate) }}% consistency rate</small>
              </div>
            </div>
            {% endif %}
            
            {% if current_streak < 7 and total_workouts < 30 and consistency_rate < 80 %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-flag-checkered mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
              <p class="small mb-0">Keep checking in to unlock achievements!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- KPI Cards -->
<section class="kpi-section mb-4">
      <div class="container-fluid">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card p-4 text-center" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
          <i class="fas fa-clipboard-list mb-3" style="font-size: 2rem; color: #10b981;"></i>
          <h6 class="text-muted mb-2">Logs</h6>
          <h2 class="fw-bold mb-0">{{ total_logs }}</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-4 text-center" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
          <i class="fas fa-check-circle mb-3" style="font-size: 2rem; color: #3b82f6;"></i>
          <h6 class="text-muted mb-2">Workouts Done</h6>
          <h2 class="fw-bold mb-0">{{ total_logs - missed }}</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-4 text-center" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
          <i class="fas fa-times-circle mb-3" style="font-size: 2rem; color: #ef4444;"></i>
          <h6 class="text-muted mb-2">Missed</h6>
          <h2 class="fw-bold mb-0">{{ missed }}</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-4 text-center" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
          <i class="fas fa-bed mb-3" style="font-size: 2rem; color: #f59e0b;"></i>
          <h6 class="text-muted mb-2">Avg Sleep</h6>
          <h2 class="fw-bold mb-0">{{ avg_sleep | round(1) if avg_sleep else '-' }}<small class="fs-6">h</small></h2>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Charts and Activity -->
<section class="charts-section mb-4">
      <div class="container-fluid">
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card p-4" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
          <h5 class="fw-bold mb-4">Recent Activity</h5>
          {% if logs %}
            <div class="activity-list">
              {% for l in logs[:6] %}
                <div class="activity-item d-flex align-items-center mb-3 p-3" style="background: #f9fafb; border-radius: 12px;">
                  <div class="activity-icon me-3">
                    {% if l.missed_workout %}
                      <i class="fas fa-exclamation-circle text-danger" style="font-size: 1.5rem;"></i>
                    {% else %}
                      <i class="fas fa-check-circle text-success" style="font-size: 1.5rem;"></i>
                    {% endif %}
                  </div>
                  <div class="flex-grow-1">
                    <strong>{{ l.date }}</strong>
                    <p class="mb-0 text-muted small">
                      Stress: <em>{{ l.stress_level }}</em> • Sleep: <strong>{{ l.sleep_hours }}h</strong> • Energy: {{ l.energy_level }}
                      {% if l.missed_workout %}<span class="badge bg-danger ms-2">Missed</span>{% endif %}
                    </p>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No activity yet. <a href="/log">Check in</a> to get started.</p>
          {% endif %}
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card p-4 decision-card" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5 class="text-white fw-bold mb-4">Latest Decision</h5>
          {% if decisions %}
            {% set d = decisions[0] %}
            <div class="decision-body">
              <div class="mb-3">
                <span class="badge bg-light text-primary me-2 mb-2">Goal: <strong>{{ d.goal_status }}</strong></span>
                <span class="badge bg-light text-primary mb-2">Wellness: <strong>{{ d.wellness_state }}</strong></span>
              </div>
              <div>
                <h6 class="text-white mb-2">Plan</h6>
                <ul class="list-unstyled plan-list">
                  {% for step in d.final_plan %}
                    <li class="plan-item mb-2">
                      <i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>
                      <span>{{ step }}</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
              <small class="text-white-50">{{ d.date }}</small>
            </div>
          {% else %}
            <p class="text-white-50">No decisions yet. Run the agent from <a href="/log" class="text-white">Check in</a>.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Leaderboard Section -->
{% if current_user and leaderboard_data %}
<section class="leaderboard-section mb-4">
      <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card p-4" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h5 class="fw-bold mb-1" style="color: #1a202c;">
                <i class="fas fa-trophy me-2" style="color: #fbbf24;"></i>
                Age Group Leaderboard ({{ current_user.age_group }})
              </h5>
              <p class="text-muted small mb-0">Compete with others in your age group</p>
            </div>
            {% if user_rank %}
            <div class="text-end">
              <div class="badge bg-primary px-3 py-2" style="font-size: 0.875rem; border-radius: 12px;">
                Your Rank: #{{ user_rank }}
              </div>
              <div class="mt-2">
                <span class="level-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 600;">
                  Level {{ current_user.level }}
                </span>
              </div>
            </div>
            {% endif %}
          </div>
          
          <div class="leaderboard-list" style="max-height: 400px; overflow-y: auto;">
            {% for user in leaderboard_data %}
            <div class="leaderboard-item mb-2 {% if user.user_id == current_user.user_id %}border border-primary{% endif %}" style="display: flex; align-items: center; padding: 1rem; background: {% if user.user_id == current_user.user_id %}rgba(102, 126, 234, 0.1){% else %}white{% endif %}; border-radius: 12px; transition: all 0.2s;">
              <div class="leaderboard-rank me-3" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.125rem; flex-shrink: 0;">
                {% if loop.index == 1 %}
                <div class="rank-1" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-crown"></i>
                </div>
                {% elif loop.index == 2 %}
                <div class="rank-2" style="background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); color: white; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  {{ loop.index }}
                </div>
                {% elif loop.index == 3 %}
                <div class="rank-3" style="background: linear-gradient(135deg, #cd7f32 0%, #b87333 100%); color: white; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  {{ loop.index }}
                </div>
                {% else %}
                <div class="rank-other" style="background: #f1f5f9; color: #475569; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  {{ loop.index }}
                </div>
                {% endif %}
              </div>
              
              <div class="flex-grow-1 d-flex align-items-center">
                {% if user.profile_photo %}
                <img src="data:image/jpeg;base64,{{ user.profile_photo }}" alt="{{ user.name }}" class="rounded-circle me-3" style="width: 48px; height: 48px; object-fit: cover; border: 2px solid #e2e8f0;">
                {% else %}
                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                  {{ user.name[0].upper() if user.name else 'U' }}
                </div>
                {% endif %}
                <div class="flex-grow-1">
                  <div class="fw-bold" style="color: #1a202c;">{{ user.name }}</div>
                  <div class="small text-muted">
                    <span class="me-2"><i class="fas fa-fire me-1"></i>{{ user.experience_points }} XP</span>
                    <span class="me-2"><i class="fas fa-dumbbell me-1"></i>{{ user.workouts_completed or 0 }} workouts</span>
                    <span><i class="fas fa-chart-line me-1"></i>{{ user.activity_level|title }}</span>
                  </div>
                </div>
                <div class="level-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 600; font-size: 0.875rem;">
                  Level {{ user.level }}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Charts Row -->
<section class="charts-row mb-4">
      <div class="container-fluid">
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-4 chart-card" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h5 class="fw-bold mb-1" style="color: #1a202c;">Sleep Over Time</h5>
              <p class="text-muted small mb-0">Track your sleep patterns</p>
            </div>
            <div class="chart-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-bed text-white"></i>
            </div>
          </div>
          <div style="position: relative; height: 250px;">
            <canvas id="sleepChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-3">
        <div class="card p-4 chart-card" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h5 class="fw-bold mb-1" style="color: #1a202c;">Stress Distribution</h5>
              <p class="text-muted small mb-0">Your stress levels</p>
            </div>
            <div class="chart-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-brain text-white"></i>
            </div>
          </div>
          <div style="position: relative; height: 250px;">
            <canvas id="stressChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-3">
        <div class="card p-4 chart-card" style="border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h5 class="fw-bold mb-1" style="color: #1a202c;">Energy Distribution</h5>
              <p class="text-muted small mb-0">Your energy levels</p>
            </div>
            <div class="chart-icon" style="width: 48px; height: 48px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-bolt text-white"></i>
            </div>
          </div>
          <div style="position: relative; height: 250px;">
            <canvas id="energyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Schedule Tasks Management
  function getTodayKey() {
    const today = new Date().toISOString().split('T')[0];
    return 'schedule_tasks_' + today;
  }

  function loadTasks() {
    const tasks = JSON.parse(localStorage.getItem(getTodayKey()) || '[]');
    const timeline = document.getElementById('scheduleTimeline');
    const noTasksMsg = document.getElementById('noTasksMsg');
    
    if (tasks.length === 0) {
      timeline.innerHTML = '<div class="text-center text-muted py-3" id="noTasksMsg"><i class="fas fa-calendar-plus mb-2" style="font-size: 2rem; opacity: 0.3;"></i><p class="small mb-0">No tasks scheduled. Add your first task!</p></div>';
      return;
    }
    
    noTasksMsg?.remove();
    timeline.innerHTML = '';
    
    // Sort tasks by time
    const sortedTasks = tasks.sort((a, b) => a.time.localeCompare(b.time));
    
    sortedTasks.forEach((task, index) => {
      const timeStr = formatTime(task.time);
      const badgeClass = getBadgeClass(task.type);
      const taskItem = document.createElement('div');
      taskItem.className = 'timeline-item mb-3';
      taskItem.setAttribute('data-task-id', task.id);
      taskItem.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="time-badge me-3" style="min-width: 70px;">
            <span class="small text-muted fw-bold">${timeStr}</span>
          </div>
          <div class="flex-grow-1 d-flex align-items-center gap-2">
            <span class="badge ${badgeClass} px-3 py-2 task-badge" style="border-radius: 8px; flex-grow: 1; text-align: left;">
              ${task.name}
            </span>
            <button class="btn btn-sm btn-outline-danger delete-task" data-task-id="${task.id}" style="border-radius: 8px; padding: 4px 8px;" title="Delete task">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;
      timeline.appendChild(taskItem);
    });
    
    // Add delete event listeners
    document.querySelectorAll('.delete-task').forEach(btn => {
      btn.addEventListener('click', function() {
        const taskId = this.getAttribute('data-task-id');
        deleteTask(taskId);
      });
    });
  }

  function formatTime(timeStr) {
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'pm' : 'am';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minutes} ${ampm}`;
  }

  function getBadgeClass(type) {
    switch(type) {
      case 'primary':
        return 'bg-primary text-white';
      case 'danger':
        return 'bg-danger text-white';
      case 'success':
        return 'bg-success text-white';
      default:
        return 'bg-light text-dark';
    }
  }

  function saveTask(task) {
    const tasks = JSON.parse(localStorage.getItem(getTodayKey()) || '[]');
    task.id = Date.now().toString();
    tasks.push(task);
    localStorage.setItem(getTodayKey(), JSON.stringify(tasks));
    loadTasks();
  }

  function deleteTask(taskId) {
    const tasks = JSON.parse(localStorage.getItem(getTodayKey()) || '[]');
    const filteredTasks = tasks.filter(task => task.id !== taskId);
    localStorage.setItem(getTodayKey(), JSON.stringify(filteredTasks));
    loadTasks();
  }


  const sleepLabels = {{ sleep_labels | tojson }};
  const sleepSeries = {{ sleep_series | tojson }};
  const stressCounts = {{ stress_counts | tojson }};
  const energyCounts = {{ energy_counts | tojson }};

  // Sleep line chart - Enhanced
  const ctxSleep = document.getElementById('sleepChart').getContext('2d');
  new Chart(ctxSleep, {
    type: 'line',
    data: { 
      labels: sleepLabels.length > 0 ? sleepLabels : ['No data'], 
      datasets: [{ 
        label: 'Sleep Hours', 
        data: sleepSeries.length > 0 ? sleepSeries : [0], 
        borderColor: '#3b82f6', 
        backgroundColor: 'rgba(59, 130, 246, 0.15)', 
        fill: true,
        tension: 0.5,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 7,
        pointBackgroundColor: '#3b82f6',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointHoverBackgroundColor: '#2563eb',
        pointHoverBorderColor: '#ffffff',
        pointHoverBorderWidth: 3
      }] 
    },
    options: { 
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { 
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: {
              size: 12,
              weight: '600',
              family: "'Segoe UI', Roboto, sans-serif"
            },
            color: '#4a5568'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: '600'
          },
          bodyFont: {
            size: 13
          },
          borderColor: '#3b82f6',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return 'Sleep: ' + context.parsed.y + ' hours';
            }
          }
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          max: 12,
          ticks: {
            stepSize: 2,
            font: {
              size: 11,
              weight: '500'
            },
            color: '#718096',
            callback: function(value) {
              return value + 'h';
            }
          },
          grid: {
            color: 'rgba(226, 232, 240, 0.8)',
            drawBorder: false
          }
        },
        x: {
          ticks: {
            font: {
              size: 11,
              weight: '500'
            },
            color: '#718096',
            maxRotation: 45,
            minRotation: 0
          },
          grid: {
            display: false
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });

  // Stress distribution - Enhanced
  const ctxStress = document.getElementById('stressChart').getContext('2d');
  const stressLabels = Object.keys(stressCounts);
  const stressData = Object.values(stressCounts);
  const stressTotal = stressData.reduce((a, b) => a + b, 0);
  
  new Chart(ctxStress, {
    type: 'doughnut',
    data: { 
      labels: stressLabels.length > 0 ? stressLabels.map(label => label.charAt(0).toUpperCase() + label.slice(1)) : ['No data'], 
      datasets: [{ 
        data: stressData.length > 0 ? stressData : [1], 
        backgroundColor: [
          'rgba(239, 68, 68, 0.9)',   // red for high
          'rgba(245, 158, 11, 0.9)',  // orange for medium
          'rgba(16, 185, 129, 0.9)'   // green for low
        ],
        borderColor: '#ffffff',
        borderWidth: 3,
        hoverBorderWidth: 4,
        hoverOffset: 8
      }] 
    },
    options: { 
      responsive: true,
      maintainAspectRatio: true,
      cutout: '65%',
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle',
            font: {
              size: 12,
              weight: '600',
              family: "'Segoe UI', Roboto, sans-serif"
            },
            color: '#4a5568',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const percentage = stressTotal > 0 ? ((value / stressTotal) * 100).toFixed(0) : 0;
                  return {
                    text: label + ' (' + percentage + '%)',
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: '600'
          },
          bodyFont: {
            size: 13
          },
          borderColor: '#ffffff',
          borderWidth: 1,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const percentage = stressTotal > 0 ? ((value / stressTotal) * 100).toFixed(1) : 0;
              return label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });

  // Energy distribution - Enhanced
  const ctxEnergy = document.getElementById('energyChart').getContext('2d');
  const energyLabels = Object.keys(energyCounts);
  const energyData = Object.values(energyCounts);
  const energyTotal = energyData.reduce((a, b) => a + b, 0);
  
  new Chart(ctxEnergy, {
    type: 'doughnut',
    data: { 
      labels: energyLabels.length > 0 ? energyLabels.map(label => label.charAt(0).toUpperCase() + label.slice(1)) : ['No data'], 
      datasets: [{ 
        data: energyData.length > 0 ? energyData : [1], 
        backgroundColor: [
          'rgba(139, 92, 246, 0.9)',  // purple for low
          'rgba(59, 130, 246, 0.9)',  // blue for medium
          'rgba(251, 191, 36, 0.9)'   // yellow for high
        ],
        borderColor: '#ffffff',
        borderWidth: 3,
        hoverBorderWidth: 4,
        hoverOffset: 8
      }] 
    },
    options: { 
      responsive: true,
      maintainAspectRatio: true,
      cutout: '65%',
      plugins: {
        legend: { 
          position: 'bottom',
          labels: {
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle',
            font: {
              size: 12,
              weight: '600',
              family: "'Segoe UI', Roboto, sans-serif"
            },
            color: '#4a5568',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const percentage = energyTotal > 0 ? ((value / energyTotal) * 100).toFixed(0) : 0;
                  return {
                    text: label + ' (' + percentage + '%)',
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: '600'
          },
          bodyFont: {
            size: 13
          },
          borderColor: '#ffffff',
          borderWidth: 1,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const percentage = energyTotal > 0 ? ((value / energyTotal) * 100).toFixed(1) : 0;
              return label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  
  // Initialize tasks when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadTasks);
  } else {
    loadTasks();
  }
  
  // Handle form submission (ensure it's set up after DOM is ready)
  const taskForm = document.getElementById('taskForm');
  if (taskForm) {
    taskForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const taskName = document.getElementById('taskName').value;
      const taskTime = document.getElementById('taskTime').value;
      const taskType = document.getElementById('taskType').value;
      
      if (taskName && taskTime) {
        saveTask({
          name: taskName,
          time: taskTime,
          type: taskType
        });
        
        // Reset form and collapse
        this.reset();
        const collapse = bootstrap.Collapse.getInstance(document.getElementById('addTaskForm'));
        collapse?.hide();
      }
    });
  }
</script>

{% endblock %}
